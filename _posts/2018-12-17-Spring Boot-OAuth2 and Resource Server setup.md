---
layout: post
title: Spring Boot-Authorization Server using Jdbc Token Store, BCrypt Password Encoder, and Resource Service
comments: false
image: /img/config-server.jpg
share-img: /img/config-server.png
gh-badge: [star, fork, follow]
tags: [spring-boot,spring-cloud,spring-security,oauth2-servier,resource-service,tutorial]
lang: en
---

OAuth 2 is an authorization framework that enables applications to obtain limited access to user accounts. 

In this tutorial, let's setup a spring boot authorization server and resource server

### Objective

 - Create `Authorization Server` using `@EnableAuthorizationServer`
 - Configure clients, users, groups in H2 DB
 - Test `Authorization Server` REST calls (`/oauth/token` with `grant_type=password`, `/oauth/check_token`, `/oauth/token` with `grant_type=refresh_token`) using POSTMAN
 - Create a `REST webservice` (`petstore service`) with REST endpoints and configure this webservice to be a` Resource Server` using `@EnableResourceServer`
 - Test `petstore service` REST calls using POSTMAN

### Prerequisites

  - [Open JDK 11](http://www.oracle.com/technetwork/java/javase/downloads/index.html){:target="_blank"}
  - [Spring Tool Suite IDE](https://spring.io/tools3/sts/all){:target="_blank"}

### Let's start

Go to [start.spring.io](https://start.spring.io/){:target="_blank"}, change the Group field to "com.codeaches", Artifact to "oauth2server" and select `Web`,`Security`,`Cloud OAuth2`,`H2` and `JPA` dependencies.

![Spring Initializer web tool](/img/oauth2server-initializer.gif){:target="_blank"}

##### Download the project

Click on `Generate Project`. You will see that the project will be downloaded as oauth2server.zip file on your hard drive.

Alternatively, you can also generate the project in a shell using cURL.

```sh
curl https://start.spring.io/starter.zip  \
	   -d dependencies=web,config server,jpa,actuator \
	   -d language=java \
	   -d type=maven-project \
	   -d groupId=com.codeaches \
	   -d artifactId=oauth2server \
	   -d bootVersion=2.1.0.RELEASE \
	   -o oauth2server.zip
```

##### Extract, import and build

Extract and import the project in STS as `Existing Maven project`. Once import is completed. Build the project using `Maven`.

##### Configure `oauth2server project` to run on port 8888

`src/main/resources/application.properties`
```properties
server.port=9040
```

##### Run the application

Run the `oauth2server project` as `Spring Boot App` and you will notice that the embedded tomcat server has started on port 9040.

````java
o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 9040 (http) with context path ''
c.c.demo.oauth2server.ConfigsvrApplication  : Started ConfigsvrApplication in 12.233 seconds (JVM running for 14.419)
````

##### Create OAuth client, access token and refresh token tables

`src/main/resources/sql/oauth2_ddl.sql`
```sql
drop table oauth_client_details if exists;
create table oauth_client_details (
    client_id varchar(256) primary key,
    resource_ids varchar(256),
    client_secret varchar(256),
    scope varchar(256),
    authorized_grant_types varchar(256),
    web_server_redirect_uri varchar(256),
    authorities varchar(256),
    access_token_validity integer,
    refresh_token_validity integer,
    additional_information varchar(4096),
    autoapprove varchar(256)
);

drop table oauth_access_token if exists;
create table oauth_access_token (
  token_id VARCHAR(256),
  token LONGVARBINARY,
  authentication_id VARCHAR(256) PRIMARY KEY,
  user_name VARCHAR(256),
  client_id VARCHAR(256),
  authentication LONGVARBINARY,
  refresh_token VARCHAR(256)
);

drop table oauth_refresh_token if exists;
create table oauth_refresh_token (
  token_id VARCHAR(256),
  token LONGVARBINARY,
  authentication LONGVARBINARY
);
```

##### Create a client `appclient`

`src/main/resources/sql/oauth2_dml.sql`
```sql
INSERT INTO
  oauth_client_details (
    client_id,
    client_secret,
    resource_ids,
    scope,
    authorized_grant_types,
    authorities,
    access_token_validity,
    refresh_token_validity
  )
VALUES
  (
    'appclient',
    '$2a$04$NUE5ncR9072hmTO9GzRNA.FQSsz/P3pPgXRLV0cxq.t3GxPvDy4FG',
    'petstore,toystore',
    'read,write',
    'authorization_code,check_token,refresh_token,password',
    'ROLE_CLIENT',
    2500,
    250000
  );
```

##### Create users, groups, group_authorities and group_members tables.

`src/main/resources/sql/groupauthorities_ddl.sql`
```sql
drop table users if exists;
create table users(
    username varchar_ignorecase(256) not null primary key,
    password varchar_ignorecase(256) not null,
    enabled boolean not null
);

drop table groups if exists;
create table groups (
    id bigint generated by default as identity(start with 0) primary key,
    group_name varchar_ignorecase(50) not null
);

drop table group_authorities if exists;
create table group_authorities (
    group_id bigint not null,
    authority varchar(50) not null,
    constraint fk_group_authorities_group foreign key(group_id) references groups(id)
);

drop table group_members if exists;
create table group_members (
    id bigint generated by default as identity(start with 0) primary key,
    username varchar(50) not null,
    group_id bigint not null,
    constraint fk_group_members_group foreign key(group_id) references groups(id)
);
```

##### Create users john and kelly.

`src/main/resources/sql/groupauthorities_dml.sql`
```sql
INSERT INTO users (username,password,enabled) 
	VALUES ('john', '$2a$04$Ts1ry6sOr1BXXie5Eez.j.bsvqC0u3x7xAwOInn2qrItwsUUIC9li', TRUE);
INSERT INTO users (username,password,enabled) 
	VALUES ('kelly','$2a$04$qkCGgz.e5dkTiZogvzxla.KXbIvWXrQzyf8wTPJOOJBKjtHAQhoBa', TRUE);
  
INSERT INTO groups (id, group_name) VALUES (1, 'USER_AND_ADMIN_GROUP');
INSERT INTO groups (id, group_name) VALUES (2, 'USER_ONLY_GROUP');

INSERT INTO group_authorities (group_id, authority) VALUES (1, 'ROLE_USER');
INSERT INTO group_authorities (group_id, authority) VALUES (1, 'ROLE_ADMIN');
INSERT INTO group_authorities (group_id, authority) VALUES (2, 'ROLE_USER');

INSERT INTO group_members (username, group_id) VALUES ('john', 1);
INSERT INTO group_members (username, group_id) VALUES ('kelly', 2);
```

##### Update the above created DDLs and DML file names in `application.properties`

`src/main/resources/application.properties`
```properties
spring.datasource.schema=classpath:sql/oauth2_ddl.sql, classpath:sql/groupauthorities_ddl.sql
spring.datasource.data=classpath:sql/oauth2_dml.sql, classpath:sql/groupauthorities_dml.sql
```

##### Configure Auth Server

`com.codeaches.oauth2server.AuthServerConfig.java`
```java
@Configuration
@EnableAuthorizationServer
public class AuthServerConfig extends AuthorizationServerConfigurerAdapter {

	@Autowired
	DataSource ds;

	@Autowired
	AuthenticationManager authMgr;

	@Autowired
	private UserDetailsService usrSvc;

	@Bean
	public TokenStore tokenStore() {
		return new JdbcTokenStore(ds);
	}

	@Bean
	PasswordEncoder passwordEncoder() {
		return new BCryptPasswordEncoder(4);
	}

	@Override
	public void configure(AuthorizationServerSecurityConfigurer cfg) throws Exception {

		cfg.tokenKeyAccess("permitAll()");
		cfg.checkTokenAccess("permitAll()");
	}

	@Override
	public void configure(ClientDetailsServiceConfigurer clients) throws Exception {
		clients.jdbc(ds);
	}

	@Override
	public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception {

		endpoints.tokenStore(tokenStore());
		endpoints.authenticationManager(authMgr);
		endpoints.userDetailsService(usrSvc);
	}
}
```

##### Configure User Security

`com.codeaches.oauth2server.UserSecurityConfig.java`
```java
@Configuration
public class UserSecurityConfig extends WebSecurityConfigurerAdapter {

	@Autowired
	DataSource ds;

	@Override
	@Bean(BeanIds.USER_DETAILS_SERVICE)
	public UserDetailsService userDetailsServiceBean() throws Exception {
		return super.userDetailsServiceBean();
	}

	@Override
	@Bean(name = BeanIds.AUTHENTICATION_MANAGER)
	public AuthenticationManager authenticationManagerBean() throws Exception {
		return super.authenticationManagerBean();
	}

	@Override
	protected void configure(AuthenticationManagerBuilder auth) throws Exception {

		JdbcUserDetailsManagerConfigurer<AuthenticationManagerBuilder> cfg = auth.jdbcAuthentication().dataSource(ds);

		cfg.getUserDetailsService().setEnableGroups(true);
		cfg.getUserDetailsService().setEnableAuthorities(false);
	}

	@Override
	protected void configure(HttpSecurity http) throws Exception {

		http.antMatcher("/**").authorizeRequests().antMatchers("/", "/login**").permitAll().anyRequest()
				.authenticated();

		http.csrf().disable();
		http.headers().frameOptions().disable();
	}
}
```

##### Restart the `oauth2server project` as `Spring Boot App`

### Summary
Congratulations! You just created a config server config server and used to to retrieve properties stored in GIT repository.

### Footnote
 - This tutorial was created based in the following link: [Spring Cloud Config Server](https://cloud.spring.io/spring-cloud-config/single/spring-cloud-config.html){:target="_blank"}
 - The code used for this tutorial can be found on [github](https://github.com/codeaches/oauth2server){:target="_blank"}
